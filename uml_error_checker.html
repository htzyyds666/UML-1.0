<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMLæ™ºèƒ½çº é”™ç³»ç»Ÿ</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --light-gray: #f8fafc;
            --border-color: #e2e8f0;
        }

        body {
            background-color: var(--light-gray);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .main-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-zone {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover {
            border-color: var(--primary-color);
            background-color: #f0f7ff;
        }

        .upload-zone.drag-over {
            border-color: var(--success-color);
            background-color: #f0fdf4;
            transform: scale(1.02);
        }

        .upload-zone.uploading {
            pointer-events: none;
            opacity: 0.7;
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* ä»»åŠ¡çŠ¶æ€é¢æ¿ */
        .task-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .task-status {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-failed {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .progress-container {
            margin: 1rem 0;
        }

        .progress {
            height: 8px;
            border-radius: 4px;
            background-color: #e2e8f0;
        }

        .progress-bar {
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .processing-steps {
            margin-top: 1rem;
        }

        .step {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-size: 0.7rem;
        }

        .step-completed {
            background-color: var(--success-color);
            color: white;
        }

        .step-current {
            background-color: var(--primary-color);
            color: white;
        }

        .step-pending {
            background-color: var(--border-color);
            color: #64748b;
        }

        /* é”™è¯¯åˆ†æç»“æœ */
        .error-analysis {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        .error-summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: var(--light-gray);
            border-radius: 8px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .summary-label {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .error-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .error-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }

        .error-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .error-syntax {
            border-left: 4px solid var(--danger-color);
        }

        .error-semantic {
            border-left: 4px solid var(--warning-color);
        }

        .error-consistency {
            border-left: 4px solid #eab308;
        }

        .error-design {
            border-left: 4px solid #ec4899;
        }

        .error-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .error-type {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .error-element {
            background-color: #f1f5f9;
            color: #475569;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .error-description {
            color: #374151;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .error-suggestion {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.9rem;
            color: #0c4a6e;
        }

        .error-suggestion::before {
            content: "ğŸ’¡ ";
            margin-right: 0.5rem;
        }

        /* å›¾åƒå¯¹æ¯”æŸ¥çœ‹å™¨ */
        .image-viewer {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        .image-tabs {
            margin-bottom: 1.5rem;
        }

        .image-container {
            position: relative;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .image-container img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .error-marker {
            position: absolute;
            border: 3px solid;
            border-radius: 4px;
            cursor: pointer;
            pointer-events: all;
        }

        .error-marker.syntax {
            border-color: var(--danger-color);
        }

        .error-marker.semantic {
            border-color: var(--warning-color);
        }

        .error-marker.consistency {
            border-color: #eab308;
        }

        .error-marker.design {
            border-color: #ec4899;
        }

        .error-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            max-width: 200px;
            z-index: 1000;
            pointer-events: none;
        }

        /* ä¿®æ­£å»ºè®®é¢æ¿ */
        .correction-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        .code-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .code-block {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .code-header {
            background-color: #f8fafc;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .code-content {
            padding: 1rem;
            background-color: #fafafa;
            overflow-x: auto;
            max-height: 300px;
        }

        .modification-notes {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .modification-notes h6 {
            color: #0c4a6e;
            margin-bottom: 0.75rem;
        }

        .modification-notes ul {
            margin: 0;
            padding-left: 1.25rem;
        }

        .modification-notes li {
            color: #374151;
            margin-bottom: 0.5rem;
        }

        /* ä¸‹è½½æŒ‰é’® */
        .download-section {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .download-btn i {
            margin-right: 0.5rem;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* ä»»åŠ¡å†å²ç®¡ç† */
        .history-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .history-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .task-history-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }

        .task-history-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .task-filename {
            font-weight: 600;
            color: var(--primary-color);
        }

        .task-time {
            font-size: 0.8rem;
            color: #64748b;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-container {
                margin-top: 1rem;
                padding: 0 1rem;
            }

            .code-comparison {
grid-template-columns: 1fr;
            }

            .download-section {
                flex-direction: column;
            }

            .history-filters {
                flex-direction: column;
            }

            .task-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* éšè—å…ƒç´  */
        .d-none {
            display: none !important;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-project-diagram me-2"></i>
                UMLæ™ºèƒ½çº é”™ç³»ç»Ÿ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#upload-section">
                            <i class="fas fa-upload me-1"></i>ä¸Šä¼ æ–‡ä»¶
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#results-section">
                            <i class="fas fa-chart-line me-1"></i>åˆ†æç»“æœ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#history-section">
                            <i class="fas fa-history me-1"></i>å†å²è®°å½•
                        </a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link" id="system-stats">
                            <i class="fas fa-server me-1"></i>
                            <span class="spinner d-none" id="stats-spinner"></span>
                            
                
<span id="stats-text">åŠ è½½ä¸­...</span>
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="container main-container">
        <div class="row">
            <!-- å·¦ä¾§ï¼šæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="col-lg-4 col-md-12 mb-4">
                <div id="upload-section">
                    <h4 class="mb-3">
                        <i class="fas fa-cloud-upload-alt me-2"></i>
                        æ–‡ä»¶ä¸Šä¼ 
                    </h4>
                    
                    <!-- ä¸Šä¼ åŒºåŸŸ -->
                    <div class="upload-zone" id="uploadZone">
                        <input type="file" class="file-input" id="fileInput" accept=".mdj,.png,.jpg,.jpeg,.bmp,.gif,.tiff">
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <div class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</div>
                            <div class="upload-hint">
                                æ”¯æŒæ ¼å¼ï¼šStarUML (.mdj) æˆ–å›¾ç‰‡ (.png, .jpg, .jpeg, .bmp, .gif, .tiff)
                            </div>
                        </div>
                        
                        <!-- ä¸Šä¼ è¿›åº¦ -->
                        <div class="upload-progress d-none" id="uploadProgress">
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="uploadProgressBar"></div>
                            </div>
                            <div class="text-center">
                                <small class="text-muted" id="uploadStatus">å‡†å¤‡ä¸Šä¼ ...</small>
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡ä»¶ä¿¡æ¯ -->
                    <div class="file-info d-none" id="fileInfo">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-file me-2"></i>
                                    æ–‡ä»¶ä¿¡æ¯
                                </h6>
                                <div class="file-details">
                                    <div class="row">
                                        <div class="col-4"><strong>æ–‡ä»¶åï¼š</strong></div>
                                        <div class="col-8" id="fileName">-</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4"><strong>æ–‡ä»¶å¤§å°ï¼š</strong></div>
                                        <div class="col-8" id="fileSize">-</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4"><strong>æ–‡ä»¶ç±»å‹ï¼š</strong></div>
                                        <div class="col-8" id="fileType">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å¿«é€Ÿæ“ä½œ -->
                    <div class="quick-actions mt-3">
                        <button class="btn btn-outline-primary btn-sm me-2" id="clearFileBtn" disabled>
                            <i class="fas fa-times me-1"></i>æ¸…é™¤æ–‡ä»¶
                        </button>
                        <button class="btn btn-primary btn-sm" id="submitTaskBtn" disabled>
                            <i class="fas fa-play me-1"></i>å¼€å§‹åˆ†æ
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç»“æœå±•ç¤ºåŒºåŸŸ -->
            <div class="col-lg-8 col-md-12">
                <div id="results-section">
                    <!-- æ¬¢è¿ä¿¡æ¯ -->
                    <div class="welcome-panel task-panel" id="welcomePanel">
                        <div class="text-center">
                            <i class="fas fa-rocket" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                            <h3>æ¬¢è¿ä½¿ç”¨UMLæ™ºèƒ½çº é”™ç³»ç»Ÿ</h3>
                            <p class="text-muted mb-4">
                                ä¸Šä¼ æ‚¨çš„UMLæ–‡ä»¶ï¼ˆStarUML .mdjæ ¼å¼æˆ–å›¾ç‰‡æ ¼å¼ï¼‰ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ†æå¹¶æ ‡æ³¨é”™è¯¯ï¼Œæä¾›ä¿®æ­£å»ºè®®ã€‚
                            </p>
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <i class="fas fa-upload text-primary mb-2" style="font-size: 2rem;"></i>
                                    <h6>ä¸Šä¼ æ–‡ä»¶</h6>
                                    <small class="text-muted">æ”¯æŒå¤šç§æ ¼å¼</small>
                                </div>
                                <div class="col-md-4">
                                    <i class="fas fa-search text-success mb-2" style="font-size: 2rem;"></i>
                                    <h6>æ™ºèƒ½åˆ†æ</h6>
                                    <small class="text-muted">AIé©±åŠ¨çš„é”™è¯¯æ£€æµ‹</small>
                                </div>
                                <div class="col-md-4">
                                    <i class="fas fa-download text-info mb-2" style="font-size: 2rem;"></i>
                                    <h6>è·å–ç»“æœ</h6>
                                    <small class="text-muted">ä¸‹è½½ä¿®æ­£å»ºè®®</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡çŠ¶æ€é¢æ¿ -->
                    <div class="task-panel d-none" id="taskPanel">
                        <div class="task-header">
                            <h5>
                                <i class="fas fa-tasks me-2"></i>
                                ä»»åŠ¡çŠ¶æ€
                            </h5>
                            <div class="task-actions">
                                <span class="task-status" id="taskStatus">ç­‰å¾…ä¸­</span>
                                <button class="btn btn-outline-danger btn-sm ms-2" id="cancelTaskBtn">
                                    <i class="fas fa-stop me-1"></i>å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                        
                        <div class="task-info">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>ä»»åŠ¡IDï¼š</strong>
                                    <span id="taskId" class="font-monospace">-</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>åˆ›å»ºæ—¶é—´ï¼š</strong>
                                    <span id="taskCreatedAt">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="progress-container">
                            <div class="d-flex justify-content-between mb-2">
                                <span>å¤„ç†è¿›åº¦</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="taskProgressBar"></div>
                            </div>
                        </div>

                        <div class="processing-steps">
                            <div class="step" id="step1">
                                <div class="step-icon step-pending">1</div>
                                <span>æ–‡ä»¶ä¸Šä¼ </span>
                            </div>
                            <div class="step" id="step2">
                                <div class="step-icon step-pending">2</div>
                                <span>è§£æUMLç»“æ„</span>
                            </div>
                            <div class="step" id="step3">
                                <div class="step-icon step-pending">3</div>
                                <span>é”™è¯¯åˆ†æ</span>
                            </div>
                            <div class="step" id="step4">
                                <div class="step-icon step-pending">4</div>
                                <span>ç”Ÿæˆæ ‡æ³¨å›¾åƒ</span>
                            </div>
                            <div class="step" id="step5">
                                <div class="step-icon step-pending">5</div>
                                <span>ç”Ÿæˆä¿®æ­£å»ºè®®</span>
                            </div>
                        </div>
                    </div>

                    <!-- é”™è¯¯åˆ†æç»“æœ -->
                    <div class="error-analysis d-none" id="errorAnalysis">
                        <h5 class="mb-3">
                            <i class="fas fa-bug me-2"></i>
                            é”™è¯¯åˆ†æç»“æœ
                        </h5>
                        
                        <div class="error-summary">
                            <div class="summary-item">
                                <div class="summary-number" id="totalErrors">0</div>
                                <div class="summary-label">æ€»é”™è¯¯æ•°</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-number text-danger" id="syntaxErrors">0</div>
                                <div class="summary-label">è¯­æ³•é”™è¯¯</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-number text-warning" id="semanticErrors">0</div>
                                <div class="summary-label">è¯­ä¹‰é”™è¯¯</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-number text-info" id="severityLevel">-</div>
                                <div class="summary-label">ä¸¥é‡ç¨‹åº¦</div>
                            </div>
                        </div>

                        <div class="error-list custom-scrollbar" id="errorList">
                            <!-- é”™è¯¯é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- å›¾åƒå¯¹æ¯”æŸ¥çœ‹å™¨ -->
                    <div class="image-viewer d-none" id="imageViewer">
                        <h5 class="mb-3">
                            <i class="fas fa-images me-2"></i>
                            å›¾åƒå¯¹æ¯”
                        </h5>
                        
                        <ul class="nav nav-tabs image-tabs" id="imageTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="original-tab" data-bs-toggle="tab" 
                                        data-bs-target="#original-image" type="button" role="tab">
                                    <i class="fas fa-image me-1"></i>åŸå§‹å›¾åƒ
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="annotated-tab" data-bs-toggle="tab" 
                                        data-bs-target="#annotated-image" type="button" role="tab">
                                    <i class="fas fa-exclamation-triangle me-1"></i>é”™è¯¯æ ‡æ³¨
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="corrected-tab" data-bs-toggle="tab" 
                                        data-bs-target="#corrected-image" type="button" role="tab">
                                    <i class="fas fa-check-circle me-1"></i>ä¿®æ­£å
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="imageTabContent">
                            <div class="tab-pane fade show active" id="original-image" role="tabpanel">
                                <div class="image-container">
                                    <img id="originalImg" src="" alt="åŸå§‹UMLå›¾åƒ" style="display: none;">
                                    <div class="text-center p-4 text-muted" id="originalPlaceholder">
                                        <i class="fas fa-image" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                        <p>åŸå§‹å›¾åƒå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="annotated-image" role="tabpanel">
                                <div class="image-container">
                                    <img id="annotatedImg" src="" alt="é”™è¯¯æ ‡æ³¨å›¾åƒ" style="display: none;">
                                    <div class="image-overlay" id="errorOverlay"></div>
                                    <div class="text-center p-4 text-muted" id="annotatedPlaceholder">
                                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                        <p>æ ‡æ³¨å›¾åƒå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="corrected-image" role="tabpanel">
                                <div class="image-container">
                                    <img id="correctedImg" src="" alt="ä¿®æ­£åå›¾åƒ" style="display: none;">
                                    <div class="text-center p-4 text-muted" id="correctedPlaceholder">
                                        <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                        <p>ä¿®æ­£åå›¾åƒå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¿®æ­£å»ºè®®é¢æ¿ -->
                    <div class="correction-panel d-none" id="correctionPanel">
                        <h5 class="mb-3">
                            <i class="fas fa-tools me-2"></i>
                            ä¿®æ­£å»ºè®®
                        </h5>
                        
                        <div class="modification-notes" id="modificationNotes">
                            <h6><i class="fas fa-lightbulb me-2"></i>ä¿®æ”¹è¯´æ˜</h6>
                            <ul id="modificationList">
                                <!-- ä¿®æ”¹è¯´æ˜å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </ul>
                        </div>

                        <div class="code-comparison">
                            <div class="code-block">
                                <div class="code-header">
                                    <i class="fas fa-code me-2"></i>åŸå§‹ä»£ç 
                                </div>
                                <div class="code-content">
                                    <pre><code id="originalCode" class="language-plantuml">// åŸå§‹PlantUMLä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º</code></pre>
                                </div>
                            </div>
                            <div class="code-block">
                                <div class="code-header">
                                    <i class="fas fa-check me-2"></i>ä¿®æ­£åä»£ç 
                                </div>
                                <div class="code-content">
                                    <pre><code id="
correctedCode" class="language-plantuml">// ä¿®æ­£åPlantUMLä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º</code></pre>
                                </div>
                            </div>
                        </div>

                        <div class="download-section">
                            <a href="#" class="download-btn btn btn-primary" id="downloadErrorAnalysis">
                                <i class="fas fa-download"></i>é”™è¯¯åˆ†ææŠ¥å‘Š
                            </a>
                            <a href="#" class="download-btn btn btn-success" id="downloadAnnotatedImage">
                                <i class="fas fa-download"></i>æ ‡æ³¨å›¾åƒ
                            </a>
                            <a href="#" class="download-btn btn btn-info" id="downloadCorrectedCode">
                                <i class="fas fa-download"></i>ä¿®æ­£ä»£ç 
                            </a>
                            <a href="#" class="download-btn btn btn-warning" id="downloadCorrectedImage">
                                <i class="fas fa-download"></i>ä¿®æ­£å›¾åƒ
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡å†å²ç®¡ç† -->
        <div class="row mt-4" id="history-section">
            <div class="col-12">
                <div class="history-panel">
                    <h5 class="mb-3">
                        <i class="fas fa-history me-2"></i>
                        ä»»åŠ¡å†å²
                    </h5>
                    
                    <div class="history-filters">
                        <select class="form-select" id="statusFilter" style="width: auto;">
                            <option value="">æ‰€æœ‰çŠ¶æ€</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="failed">å¤±è´¥</option>
                            <option value="processing">å¤„ç†ä¸­</option>
                            <option value="pending">ç­‰å¾…ä¸­</option>
                        </select>
                        <button class="btn btn-outline-primary btn-sm" id="refreshHistoryBtn">
                            <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°
                        </button>
                        <button class="btn btn-outline-danger btn-sm" id="clearHistoryBtn">
                            <i class="fas fa-trash me-1"></i>æ¸…ç©ºå†å²
                        </button>
                    </div>

                    <div class="task-history-list" id="taskHistoryList">
                        <!-- å†å²ä»»åŠ¡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        <div class="text-center p-4 text-muted" id="historyPlaceholder">
                            <i class="fas fa-clock" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>æš‚æ— å†å²ä»»åŠ¡</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Prism.js for code highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script>
        /**
         * UMLé”™è¯¯æ£€æŸ¥å™¨ä¸»ç±»
         */
        class UMLErrorChecker {
            constructor() {
                this.apiBase = 'http://localhost:8000';
                this.currentTask = null;
                this.pollInterval = null;
                this.currentFile = null;
                
                this.init();
            }

            /**
             * åˆå§‹åŒ–åº”ç”¨
             */
            init() {
                this.setupEventListeners();
                this.loadSystemStats();
                this.loadTaskHistory();
                
                // å®šæœŸæ›´æ–°ç³»ç»Ÿç»Ÿè®¡
                setInterval(() => this.loadSystemStats(), 30000);
            }

            /**
             * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
             */
            setupEventListeners() {
                // æ–‡ä»¶ä¸Šä¼ ç›¸å…³
                const uploadZone = document.getElementById('uploadZone');
                const fileInput = document.getElementById('fileInput');
                
                // æ‹–æ‹½ä¸Šä¼ 
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('drag-over');
                });
                
                uploadZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('drag-over');
                });
                
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFileSelect(files[0]);
                    }
                });
                
                // æ–‡ä»¶é€‰æ‹©
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileSelect(e.target.files[0]);
                    }
                });
                
                // æŒ‰é’®äº‹ä»¶
                document.getElementById('clearFileBtn').addEventListener('click', () => this.clearFile());
                document.getElementById('submitTaskBtn').addEventListener('click', () => this.submitTask());
                document.getElementById('cancelTaskBtn').addEventListener('click', () => this.cancelTask());
                
                // å†å²ç®¡ç†
                document.getElementById('refreshHistoryBtn').addEventListener('click', () => this.loadTaskHistory());
                document.getElementById('clearHistoryBtn').addEventListener('click', () => this.clearHistory());
                document.getElementById('statusFilter').addEventListener('change', () => this.loadTaskHistory());
                
                // ä¸‹è½½æŒ‰é’®
                document.getElementById('downloadErrorAnalysis').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.downloadFile('error_analysis');
                });
                document.getElementById('downloadAnnotatedImage').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.downloadFile('annotated_image');
                });
                document.getElementById('downloadCorrectedCode').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.downloadFile('corrected_uml');
                });
                document.getElementById('downloadCorrectedImage').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.downloadFile('corrected_image');
                });
            }

            /**
             * å¤„ç†æ–‡ä»¶é€‰æ‹©
             */
            handleFileSelect(file) {
                // éªŒè¯æ–‡ä»¶ç±»å‹
                const allowedTypes = ['.mdj', '.png', '.jpg', '.jpeg', '.bmp', '.gif', '.tiff'];
                const fileExt = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                
                if (!allowedTypes.includes(fileExt)) {
                    this.showAlert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼è¯·é€‰æ‹©StarUML (.mdj) æˆ–å›¾ç‰‡æ–‡ä»¶ã€‚', 'danger');
                    return;
                }
                
                this.currentFile = file;
                this.displayFileInfo(file);
                
                // å¯ç”¨æŒ‰é’®
                document.getElementById('clearFileBtn').disabled = false;
                document.getElementById('submitTaskBtn').disabled = false;
            }

            /**
             * æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
             */
            displayFileInfo(file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = this.formatFileSize(file.size);
                document.getElementById('fileType').textContent = this.getFileType(file.name);
                
                document.getElementById('fileInfo').classList.remove('d-none');
            }

            /**
             * æ¸…é™¤æ–‡ä»¶
             */
            clearFile() {
                this.currentFile = null;
                document.getElementById('fileInput').value = '';
                document.getElementById('fileInfo').classList.add('d-none');
                
                // ç¦ç”¨æŒ‰é’®
                document.getElementById('clearFileBtn').disabled = true;
                document.getElementById('submitTaskBtn').disabled = true;
            }

            /**
             * æäº¤ä»»åŠ¡
             */
            async submitTask() {
                if (!this.currentFile) {
                    this.showAlert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼', 'warning');
                    return;
                }

                try {
                    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                    this.showUploadProgress();
                    
                    // ç¡®å®šä»»åŠ¡ç±»å‹
                    const taskType = this.currentFile.name.toLowerCase().endsWith('.mdj') ? 'staruml' : 'image';
                    
                    // åˆ›å»ºFormData
                    const formData = new FormData();
                    formData.append('file', this.currentFile);
                    formData.append('task_type', taskType);
                    
                    // æäº¤ä»»åŠ¡
                    const response = await fetch(`${this.apiBase}/api/tasks/submit`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    
                    // éšè—ä¸Šä¼ è¿›åº¦
                    this.hideUploadProgress();
                    
                    // å¼€å§‹ç›‘æ§ä»»åŠ¡
                    this.currentTask = result.task_id;
                    this.startTaskMonitoring(result.task_id);
                    
                    // éšè—æ¬¢è¿é¢æ¿ï¼Œæ˜¾ç¤ºä»»åŠ¡é¢æ¿
                    document.getElementById('welcomePanel').classList.add('d-none');
                    document.getElementById('taskPanel').classList.remove('d-none');
                    
                    this.showAlert('ä»»åŠ¡æäº¤æˆåŠŸï¼æ­£åœ¨å¤„ç†ä¸­...', 'success');
                    
                } catch (error) {
                    this.hideUploadProgress();
                    this.showAlert(`ä»»åŠ¡æäº¤å¤±è´¥: ${error.message}`, 'danger');
                    console.error('Submit task error:', error);
                }
            }

            /**
             * å¼€å§‹ä»»åŠ¡ç›‘æ§
             */
            startTaskMonitoring(taskId) {
                // æ›´æ–°ä»»åŠ¡ä¿¡æ¯
                document.getElementById('taskId').textContent = taskId;
                document.getElementById('taskCreatedAt').textContent = new Date().toLocaleString();
                
                // å¼€å§‹è½®è¯¢
                this.pollInterval = setInterval(() => {
                    this.checkTaskStatus(taskId);
                }, 2000);
                
                // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
                this.checkTaskStatus(taskId);
            }

            /**
             * æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
             */
            async checkTaskStatus(taskId) {
                try {
                    const response = await fetch(`${this.apiBase}/api/tasks/${taskId}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const taskData = await response.json();
                    this.updateTaskDisplay(taskData);
                    
                    // å¦‚æœä»»åŠ¡å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢è½®è¯¢
                    if (taskData.status === 'completed' || taskData.status === 'failed') {
                        clearInterval(this.pollInterval);
                        this.pollInterval = null;
                        
                        if (taskData.status === 'completed') {
                            this.displayResults(taskData);
                        } else {
                            this.showAlert(`ä»»åŠ¡å¤±è´¥: ${taskData.error_message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                        }
                    }
                    
                } catch (error) {
                    console.error('Check task status error:', error);
                    this.showAlert(`æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${error.message}`, 'danger');
                }
            }

            /**
             * æ›´æ–°ä»»åŠ¡æ˜¾ç¤º
             */
            updateTaskDisplay(taskData) {
                // æ›´æ–°çŠ¶æ€
                const statusElement = document.getElementById('taskStatus');
                statusElement.textContent = this.getStatusText(taskData.status);
                statusElement.className = `task-status status-${taskData.status}`;
                
                // æ›´æ–°è¿›åº¦
                const progress = taskData.progress || 0;
                document.getElementById('progressPercent').textContent = `${progress}%`;
                document.getElementById('taskProgressBar').style.width = `${progress}%`;
                
                // æ›´æ–°æ­¥éª¤
                this.updateProcessingSteps(progress);
            }

            /**
             * æ›´æ–°å¤„ç†æ­¥éª¤
             */
            updateProcessingSteps(progress) {
                const steps = [
                    { id: 'step1', threshold: 10 },
                    { id: 'step2', threshold: 30 },
                    { id: 'step3', threshold: 50 },
                    { id: 'step4', threshold: 70 },
                    { id: 'step5', threshold: 90 }
                ];
                
                steps.forEach((step, index) => {
                    const stepElement = document.getElementById(step.id);
                    const iconElement = stepElement.querySelector('.step-icon');
                    
                    if (progress >= step.threshold) {
                        iconElement.className = 'step-icon step-completed';
                        iconElement.innerHTML = '<i class="fas fa-check"></i>';
                    } else if (index === 0 || progress >= steps[index - 1].threshold) {
                        iconElement.className = 'step-icon step-current';
                        iconElement.innerHTML = index + 1;
                    } else {
                        iconElement.className = 'step-icon step-pending';
                        iconElement.innerHTML = index + 1;
                    }
                });
            }

            /**
             * æ˜¾ç¤ºç»“æœ
             */
            async displayResults(taskData) {
                try {
                    // è·å–é”™è¯¯åˆ†æç»“æœ
                    if (taskData.result_links && taskData.result_links.error_analysis) {
                        const errorResponse = await fetch(`${this.apiBase}${taskData.result_links.error_analysis}`);
                        if (errorResponse.ok) {
                            const errorData = await errorResponse.json();
                            this.displayErrorAnalysis(errorData);
                        }
                    }
                    
                    // æ˜¾ç¤ºå›¾åƒ
                    this.displayImages(taskData);
                    
                    // æ˜¾ç¤ºä¿®æ­£å»ºè®®
                    if (taskData.result_links && taskData.result_links.corrected_uml) {
                        const correctionResponse = await fetch(`${this.apiBase}${taskData.result_links.corrected_uml}`);
                        if (correctionResponse.ok) {
                            const correctionData = await correctionResponse.json();
                            this.displayCorrections(correctionData);
                        }
                    }
                    
                    // æ›´æ–°ä¸‹è½½é“¾æ¥
                    this.updateDownloadLinks(taskData);
                    
                    // åˆ·æ–°å†å²è®°å½•
                
this.loadTaskHistory();
                    
                } catch (error) {
                    console.error('Display results error:', error);
                    this.showAlert(`æ˜¾ç¤ºç»“æœå¤±è´¥: ${error.message}`, 'danger');
                }
            }

            /**
             * æ˜¾ç¤ºé”™è¯¯åˆ†æ
             */
            displayErrorAnalysis(errorData) {
                const errors = errorData.errors || [];
                const summary = errorData.summary || {};
                
                // æ›´æ–°æ‘˜è¦
                document.getElementById('totalErrors').textContent = errors.length;
                document.getElementById('syntaxErrors').textContent = 
                    errors.filter(e => e.type === 'è¯­æ³•é”™è¯¯').length;
                document.getElementById('semanticErrors').textContent = 
                    errors.filter(e => e.type === 'è¯­ä¹‰é”™è¯¯').length;
                document.getElementById('severityLevel').textContent = summary.severity_level || '-';
                
                // ç”Ÿæˆé”™è¯¯åˆ—è¡¨
                const errorList = document.getElementById('errorList');
                errorList.innerHTML = '';
                
                if (errors.length === 0) {
                    errorList.innerHTML = `
                        <div class="text-center p-4 text-success">
                            <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h5>æ­å–œï¼æœªå‘ç°é”™è¯¯</h5>
                            <p class="text-muted">æ‚¨çš„UMLå›¾ç¬¦åˆè§„èŒƒè¦æ±‚</p>
                        </div>
                    `;
                } else {
                    errors.forEach((error, index) => {
                        const errorItem = this.createErrorItem(error, index + 1);
                        errorList.appendChild(errorItem);
                    });
                }
                
                // æ˜¾ç¤ºé”™è¯¯åˆ†æé¢æ¿
                document.getElementById('errorAnalysis').classList.remove('d-none');
            }

            /**
             * åˆ›å»ºé”™è¯¯é¡¹å…ƒç´ 
             */
            createErrorItem(error, index) {
                const div = document.createElement('div');
                div.className = `error-item error-${error.type.toLowerCase().replace('é”™è¯¯', '')}`;
                
                div.innerHTML = `
                    <div class="error-header">
                        <span class="error-type">${index}. ${error.type}</span>
                        <span class="error-element">${error.element}</span>
                    </div>
                    <div class="error-description">${error.error_description}</div>
                    <div class="error-suggestion">${error.suggestion}</div>
                `;
                
                return div;
            }

            /**
             * æ˜¾ç¤ºå›¾åƒ
             */
            displayImages(taskData) {
                const links = taskData.result_links || {};
                
                // åŸå§‹å›¾åƒï¼ˆå¦‚æœæ˜¯å›¾ç‰‡ä»»åŠ¡ï¼‰
                if (taskData.task_type === 'image') {
                    // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºåŸå§‹ä¸Šä¼ çš„å›¾åƒ
                    // ç”±äºå®‰å…¨é™åˆ¶ï¼Œæˆ‘ä»¬æ˜¾ç¤ºå ä½ç¬¦
                    document.getElementById('originalPlaceholder').innerHTML = `
                        <i class="fas fa-image" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>åŸå§‹å›¾åƒ: ${taskData.original_filename}</p>
                    `;
                }
                
                // æ ‡æ³¨å›¾åƒ
                if (links.annotated_image) {
                    const annotatedImg = document.getElementById('annotatedImg');
                    annotatedImg.src = `${this.apiBase}${links.annotated_image}`;
                    annotatedImg.style.display = 'block';
                    const annotatedPlaceholder = document.getElementById('annotatedPlaceholder');
                    if (annotatedPlaceholder) {
                        annotatedPlaceholder.style.display = 'none';
                    }
                }
                
                // ä¿®æ­£åå›¾åƒ
                if (links.corrected_image) {
                    const correctedImg = document.getElementById('correctedImg');
                    correctedImg.src = `${this.apiBase}${links.corrected_image}`;
                    correctedImg.style.display = 'block';
                    const correctedPlaceholder = document.getElementById('correctedPlaceholder');
                    if (correctedPlaceholder) {
                        correctedPlaceholder.style.display = 'none';
                    }
                }
                
                // æ˜¾ç¤ºå›¾åƒæŸ¥çœ‹å™¨
                document.getElementById('imageViewer').classList.remove('d-none');
            }

            /**
             * æ˜¾ç¤ºä¿®æ­£å»ºè®®
             */
            displayCorrections(correctionData) {
                // æ˜¾ç¤ºä¿®æ”¹è¯´æ˜
                const modificationList = document.getElementById('modificationList');
                modificationList.innerHTML = '';
                
                if (correctionData.modification_notes) {
                    const notes = correctionData.modification_notes.split('\n')
                        .filter(line => line.trim().startsWith('- ä¿®æ”¹'))
                        .map(line => line.replace('- ä¿®æ”¹', '').trim());
                    
                    notes.forEach(note => {
                        const li = document.createElement('li');
                        li.textContent = note;
                        modificationList.appendChild(li);
                    });
                }
                
                // æ˜¾ç¤ºä»£ç å¯¹æ¯”
                if (correctionData.original_plantuml) {
                    document.getElementById('originalCode').textContent = correctionData.original_plantuml;
                }
                
                if (correctionData.corrected_plantuml) {
                    document.getElementById('correctedCode').textContent = correctionData.corrected_plantuml;
                }
                
                // é‡æ–°é«˜äº®ä»£ç 
                if (window.Prism) {
                    Prism.highlightAll();
                }
                
                // æ˜¾ç¤ºä¿®æ­£é¢æ¿
                document.getElementById('correctionPanel').classList.remove('d-none');
            }

            /**
             * æ›´æ–°ä¸‹è½½é“¾æ¥
             */
            updateDownloadLinks(taskData) {
                const links = taskData.result_links || {};
                
                // æ›´æ–°ä¸‹è½½æŒ‰é’®çš„hrefå±æ€§
                if (links.error_analysis) {
                    document.getElementById('downloadErrorAnalysis').href = `${this.apiBase}${links.error_analysis}`;
                }
                if (links.annotated_image) {
                    document.getElementById('downloadAnnotatedImage').href = `${this.apiBase}${links.annotated_image}`;
                }
                if (links.corrected_uml) {
                    document.getElementById('downloadCorrectedCode').href = `${this.apiBase}${links.corrected_uml}`;
                }
                if (links.corrected_image) {
                    document.getElementById('downloadCorrectedImage').href = `${this.apiBase}${links.corrected_image}`;
                }
            }

            /**
             * ä¸‹è½½æ–‡ä»¶
             */
            async downloadFile(fileType) {
                if (!this.currentTask) {
                    this.showAlert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶ï¼', 'warning');
                    return;
                }
                
                try {
                    const response = await fetch(`${this.apiBase}/api/tasks/${this.currentTask}/files/${fileType}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.currentTask}_${fileType}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    window.URL.revokeObjectURL(url);
                    
                } catch (error) {
                    console.error('Download file error:', error);
                    this.showAlert(`ä¸‹è½½å¤±è´¥: ${error.message}`, 'danger');
                }
            }

            /**
             * å–æ¶ˆä»»åŠ¡
             */
            async cancelTask() {
                if (!this.currentTask) return;
                
                try {
                    const response = await fetch(`${this.apiBase}/api/tasks/${this.currentTask}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        this.showAlert('ä»»åŠ¡å·²å–æ¶ˆ', 'info');
                    }
                    
                } catch (error) {
                    console.error('Cancel task error:', error);
                }
                
                // åœæ­¢è½®è¯¢
                if (this.pollInterval) {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                }
                
                // é‡ç½®ç•Œé¢
                this.resetInterface();
            }

            /**
             * é‡ç½®ç•Œé¢
             */
            resetInterface() {
                this.currentTask = null;
                
                // éšè—æ‰€æœ‰ç»“æœé¢æ¿
                document.getElementById('taskPanel').classList.add('d-none');
                document.getElementById('errorAnalysis').classList.add('d-none');
                document.getElementById('imageViewer').classList.add('d-none');
                document.getElementById('correctionPanel').classList.add('d-none');
                
                // æ˜¾ç¤ºæ¬¢è¿é¢æ¿
                document.getElementById('welcomePanel').classList.remove('d-none');
                
                // æ¸…é™¤æ–‡ä»¶
                this.clearFile();
            }

            /**
             * åŠ è½½ç³»ç»Ÿç»Ÿè®¡
             */
            async loadSystemStats() {
                try {
                    const response = await fetch(`${this.apiBase}/api/stats`);
                    
                    if (response.ok) {
                        const stats = await response.json();
                        document.getElementById('stats-text').textContent = 
                            `é˜Ÿåˆ—: ${stats.queue_size} | å®Œæˆ: ${stats.completed_tasks}`;
                    } else {
                        document.getElementById('stats-text').textContent = 'æœåŠ¡å™¨ç¦»çº¿';
                    }
                    
                } catch (error) {
                    document.getElementById('stats-text').textContent = 'è¿æ¥å¤±è´¥';
                }
            }

            /**
             * åŠ è½½ä»»åŠ¡å†å²
             */
            async loadTaskHistory() {
                try {
                    const statusFilter = document.getElementById('statusFilter').value;
                    let url = `${this.apiBase}/api/tasks?limit=20`;
                    
                    if (statusFilter) {
                        url += `&status=${statusFilter}`;
                    }
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.displayTaskHistory(data.tasks);
                    
                } catch (error) {
                    console.error('Load task history error:', error);
                    this.showAlert(`åŠ è½½å†å²è®°å½•å¤±è´¥: ${error.message}`, 'danger');
                }
            }

            /**
             * æ˜¾ç¤ºä»»åŠ¡å†å²
             */
            displayTaskHistory(tasks) {
                const historyList = document.getElementById('taskHistoryList');
                const placeholder = document.getElementById('historyPlaceholder');
                
                if (tasks.length === 0) {
                    if (placeholder) {
                        placeholder.style.display = 'block';
                    }
                    historyList.innerHTML = '';
                    if (placeholder) {
                        historyList.appendChild(placeholder);
                    }
                    return;
                }
                
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
                historyList.innerHTML = '';
                
                tasks.forEach(task => {
                    const taskItem = this.createHistoryItem(task);
                    historyList.appendChild(taskItem);
                });
            }

            /**
             * åˆ›å»ºå†å²é¡¹å…ƒç´ 
             */
            createHistoryItem(task) {
                const div = document.createElement('div');
                div.className = 'task-history-item';
                
                const statusClass = `status-${task.status}`;
                const statusText = this.getStatusText(task.status);
                const createdAt = new Date(task.created_at).toLocaleString();
                
                div.innerHTML = `
                    <div class="task-meta">
                        <span class="task-filename">${task.original_filename}</span>
                        <span class="task-time">${createdAt}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="task-status ${statusClass}">${statusText}</span>
                        <div class="task-actions">
                            ${task.status === 'completed' ? `
                                <button class="btn btn-outline-primary btn-sm" onclick="app.viewTask('${task.task_id}')">
                                    <i class="fas fa-eye me-1"></i>æŸ¥çœ‹
                                </button>
                            ` : ''}
                            <button class="btn btn-outline-danger btn-sm" onclick="app.deleteTask('${task.task_id}')">
                                <i class="fas fa-trash me-1"></i>åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
                
                return div;
            }

            /**
             * æŸ¥çœ‹å†å²ä»»åŠ¡
             */
            async viewTask(taskId) {
                try {
                    const response = await fetch(`${this.apiBase}/api/tasks/${taskId}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const taskData = await response.json();
                    
                    if (taskData.status === 'completed') {
                        this.currentTask = taskId;
                        this.displayResults(taskData);
                        
                        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                        document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
                    }
                    
                } catch (error) {
                    console.error('View task error:', error);
                    this.showAlert(`æŸ¥çœ‹ä»»åŠ¡å¤±è´¥: ${error.message}`, 'danger');
                }
            }

            /**
             * åˆ é™¤ä»»åŠ¡
             */
            async deleteTask(taskId) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                    return;
                }
                
                try {
                    const response = await fetch(`${this.apiBase}/api/tasks/${taskId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        this.showAlert('ä»»åŠ¡å·²åˆ é™¤', 'success');
                        this.loadTaskHistory();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    console.error('Delete task error:', error);
                    this.showAlert(`åˆ é™¤ä»»åŠ¡å¤±è´¥: ${error.message}`, 'danger');
                }
            }

            /**
             * æ¸…ç©ºå†å²
             */
            async clearHistory() {
                if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    return;
                }
                
                try {
                    // è·å–æ‰€æœ‰ä»»åŠ¡
                    const response = await fetch(`${this.apiBase}/api/tasks`);
                    if (!response.ok) return;
                    
                    const data = await response.json();
                    const tasks = data.
tasks;
                    
                    // æ‰¹é‡åˆ é™¤æ‰€æœ‰ä»»åŠ¡
                    const deletePromises = tasks.map(task => 
                        fetch(`${this.apiBase}/api/tasks/${task.task_id}`, { method: 'DELETE' })
                    );
                    
                    await Promise.all(deletePromises);
                    
                    this.showAlert('å†å²è®°å½•å·²æ¸…ç©º', 'success');
                    this.loadTaskHistory();
                    
                } catch (error) {
                    console.error('Clear history error:', error);
                    this.showAlert(`æ¸…ç©ºå†å²å¤±è´¥: ${error.message}`, 'danger');
                }
            }

            /**
             * æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
             */
            showUploadProgress() {
                document.getElementById('uploadProgress').classList.remove('d-none');
                document.querySelector('.upload-content').style.display = 'none';
                document.getElementById('uploadZone').classList.add('uploading');
                
                // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
                let progress = 0;
                const progressBar = document.getElementById('uploadProgressBar');
                const statusText = document.getElementById('uploadStatus');
                
                const interval = setInterval(() => {
                    progress += Math.random() * 30;
                    if (progress > 90) progress = 90;
                    
                    progressBar.style.width = `${progress}%`;
                    statusText.textContent = `ä¸Šä¼ ä¸­... ${Math.round(progress)}%`;
                    
                    if (progress >= 90) {
                        clearInterval(interval);
                        statusText.textContent = 'å¤„ç†ä¸­...';
                    }
                }, 200);
            }

            /**
             * éšè—ä¸Šä¼ è¿›åº¦
             */
            hideUploadProgress() {
                document.getElementById('uploadProgress').classList.add('d-none');
                document.querySelector('.upload-content').style.display = 'block';
                document.getElementById('uploadZone').classList.remove('uploading');
            }

            /**
             * æ˜¾ç¤ºæç¤ºä¿¡æ¯
             */
            showAlert(message, type = 'info') {
                // åˆ›å»ºæç¤ºæ¡†
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(alertDiv);
                
                // è‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 5000);
            }

            /**
             * å·¥å…·æ–¹æ³•ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
             */
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            /**
             * å·¥å…·æ–¹æ³•ï¼šè·å–æ–‡ä»¶ç±»å‹
             */
            getFileType(filename) {
                const ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
                
                switch (ext) {
                    case '.mdj':
                        return 'StarUML æ–‡ä»¶';
                    case '.png':
                        return 'PNG å›¾åƒ';
                    case '.jpg':
                    case '.jpeg':
                        return 'JPEG å›¾åƒ';
                    case '.bmp':
                        return 'BMP å›¾åƒ';
                    case '.gif':
                        return 'GIF å›¾åƒ';
                    case '.tiff':
                        return 'TIFF å›¾åƒ';
                    default:
                        return 'æœªçŸ¥ç±»å‹';
                }
            }

            /**
             * å·¥å…·æ–¹æ³•ï¼šè·å–çŠ¶æ€æ–‡æœ¬
             */
            getStatusText(status) {
                const statusMap = {
                    'pending': 'ç­‰å¾…ä¸­',
                    'processing': 'å¤„ç†ä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'failed': 'å¤±è´¥'
                };
                
                return statusMap[status] || status;
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new UMLErrorChecker();
        });

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        // ç½‘ç»œçŠ¶æ€ç›‘æ§
        window.addEventListener('online', () => {
            if (app) {
                app.showAlert('ç½‘ç»œè¿æ¥å·²æ¢å¤', 'success');
                app.loadSystemStats();
            }
        });

        window.addEventListener('offline', () => {
            if (app) {
                app.showAlert('ç½‘ç»œè¿æ¥å·²æ–­å¼€', 'warning');
            }
        });
    </script>
</body>
</html>